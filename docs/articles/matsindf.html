<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Use Cases and Examples for <code>matsindf</code> • matsindf</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Use Cases and Examples for &lt;code&gt;matsindf&lt;/code&gt;">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">matsindf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/matsindf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/midf_apply_primer.html">A matsindf_apply primer</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MatthewHeun/matsindf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Use Cases and Examples for <code>matsindf</code>
</h1>
                        <h4 class="author">Matthew Kuperus Heun</h4>
            
            <h4 class="date">2019-02-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MatthewHeun/matsindf/blob/master/vignettes/matsindf.Rmd"><code>vignettes/matsindf.Rmd</code></a></small>
      <div class="hidden name"><code>matsindf.Rmd</code></div>

    </div>

    
    
<!-- Establish some helpful LaTeX shortcuts for equations -->
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Matrices are important mathematical objects, and they often describe networks of flows among nodes. Example networks are given in the following table.</p>
<table class="table">
<thead><tr class="header">
<th align="left">System type</th>
<th align="left">Flows</th>
<th align="left">Nodes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Ecological</td>
<td align="left">nutrients</td>
<td align="left">organisms</td>
</tr>
<tr class="even">
<td align="left">Manufacturing</td>
<td align="left">materials</td>
<td align="left">factories</td>
</tr>
<tr class="odd">
<td align="left">Economic</td>
<td align="left">money</td>
<td align="left">economic sectors</td>
</tr>
</tbody>
</table>
<p>The power of matrices lies in their ability to organize network-wide calculations, thereby simplifying the work of analysts who study entire systems.</p>
<p>But <a href="https://en.wikipedia.org/wiki/Wouldn%27t_It_Be_Nice">wouldn’t it be nice</a> if there were an easy way to create data frames whose entries were not numbers but entire matrices? If that were possible, matrix algebra could be performed on columns of similar matrices.</p>
<p>That’s the reason for <code>matsindf</code>. It provides functions to convert a suitably-formatted <a href="http://tidyr.tidyverse.org/articles/tidy-data.html">tidy</a> data frame into a data frame containing a column of matrices.</p>
<p>Furthermore, <code>matsbyname</code> is a sister package that …</p>
<ul>
<li>… provides matrix algebra functions that respect names of matrix rows and columns (<code>dimnames</code> in <code>R</code>) to free the analyst from the task of aligning rows and columns of operands (matrices) passed to matrix algebra functions and</li>
<li>… allows matrix algebra to be conducted within data frames using <a href="http://dplyr.tidyverse.org">dplyr</a>, <a href="http://tidyr.tidyverse.org">tidyr</a>, and other <a href="http://www.tidyverse.org">tidyverse</a> functions.</li>
</ul>
<p>When used together, <code>matsindf</code> and <code>matsbyname</code> allow analysts to wield simultaneously the power of both <a href="https://en.wikipedia.org/wiki/Matrix_(mathematics)">matrix mathematics</a> and <a href="http://www.tidyverse.org">tidyverse</a> functional programming.</p>
<p>This vignette demonstrates the use of these packages and suggests a workflow to accomplish sophisticated analyses using <em>matrices in data frames</em> (<code>matsindf</code>).</p>
</div>
<div id="data-ukenergy2000" class="section level2">
<h2 class="hasAnchor">
<a href="#data-ukenergy2000" class="anchor"></a>Data: <code>UKEnergy2000</code>
</h2>
<p>To demonstrate the use of <code>matsindf</code> functions, consider a network of energy flows from the environment, through transformation and distribution processes, and, ultimately, to final demand. Such energy flow networks are called energy conversion chains (ECCs), and this example is based on an approximation to a portion of the UK’s ECC circa 2000. (Note that these data are to be used for demonstration purposes only and have been rounded to 1–2 significant digits.) These example data first appeared in Figures 3 and 4 of Heun, Owen, and Brockway <span class="citation">(2018)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(UKEnergy2000, <span class="dv">2</span>)
<span class="co">#&gt;   Country Year Ledger.side      Flow.aggregation.point              Flow</span>
<span class="co">#&gt; 1      GB 2000      Supply Total primary energy supply Resources - Crude</span>
<span class="co">#&gt; 2      GB 2000      Supply Total primary energy supply    Resources - NG</span>
<span class="co">#&gt;   Product E.ktoe</span>
<span class="co">#&gt; 1   Crude  50000</span>
<span class="co">#&gt; 2      NG  43000</span></code></pre></div>
<p><code>Country</code> and <code>Year</code> contain only one value each, <code>GB</code> and <code>2000</code> respectively. Following conventions of the <a href="http://www.iea.org">International Energy Agency</a>’s <a href="http://www.iea.org/statistics/relateddatabases/worldenergystatisticsandbalances/">energy balance tables</a>,</p>
<ul>
<li>
<code>Ledger.side</code> indicates <code>Supply</code> or <code>Consumption</code>;</li>
<li>
<code>Flow.aggregation.point</code> indicates how data are to be aggregated;</li>
<li>
<code>Flow</code> indicates the industry, machine, or final demand sector for this flow;</li>
<li>
<code>Product</code> indicates the energy carrier for this flow; and</li>
<li>
<code>E.ktoe</code> gives the magnitude of this flow in <a href="https://www.iea.org/statistics/resources/unitconverter/">units</a> of kilotons of oil equivalent (ktoe).</li>
</ul>
<p>Each flow is its own observation (its own row) in the <code>UKEnergy2000</code> data frame, making it <a href="http://tidyr.tidyverse.org/articles/tidy-data.html">tidy</a>.</p>
<p>The remainder of this vignette demonstrates an analysis conducted using the <code>UKEnergy2000</code> data frame as a basis. It:</p>
<ul>
<li>shows how to <em>collapse</em> and spread the data into appropriate matrices stored in columns of a data frame,</li>
<li>demonstrates analyzing the matrices with <code>matsbyname</code> functions,</li>
<li>illustrates <em>expand</em>ing the matrices back into a tidy data frame, and</li>
<li>uses <a href="http://ggplot2.tidyverse.org">ggplot</a> to graph the results.</li>
</ul>
</div>
<div id="suggested-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#suggested-workflow" class="anchor"></a>Suggested workflow</h2>
<div id="prepare-for-collapse" class="section level3">
<h3 class="hasAnchor">
<a href="#prepare-for-collapse" class="anchor"></a>Prepare for <em>collapse</em>
</h3>
<p>The <code>EnergyUK2000</code> data frame is similar to “cleaned” data from an external source: there are no missing entries, and it is <a href="http://tidyr.tidyverse.org/articles/tidy-data.html">tidy</a>. But the data are not organized as matrices, and additional metadata is needed.</p>
<p>The <code>collapse_to_matrices</code> function converts a tidy data frame into a <code>matsindf</code> data frame using using information within the tidy data frame. So the first task is to prepare for <em>collapse</em> by adding metadata columns.</p>
<p><code>collapse_to_matrices</code> needs the following information:</p>
<table class="table">
<thead><tr class="header">
<th align="right">argument to <code>collapse_to_matrices</code>
</th>
<th align="left">identifies</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right"><code>matnames</code></td>
<td align="left">Name of the input column of matrix names</td>
</tr>
<tr class="even">
<td align="right"><code>values</code></td>
<td align="left">Name of the input column of matrix entries</td>
</tr>
<tr class="odd">
<td align="right"><code>rownames</code></td>
<td align="left">Name of the input column of matrix row names</td>
</tr>
<tr class="even">
<td align="right"><code>colnames</code></td>
<td align="left">Name of the input column of matrix column name</td>
</tr>
<tr class="odd">
<td align="right"><code>rowtypes</code></td>
<td align="left">Optional name of the input column of matrix row types</td>
</tr>
<tr class="even">
<td align="right"><code>coltypes</code></td>
<td align="left">Optional name of the input column of matrix column types</td>
</tr>
</tbody>
</table>
<p>The following code gives the approach to adding metadata, appropriate for this application, relying on <code>Ledger.side</code>, the sign of <code>E.ktoe</code>, and knowledge about the rows and columns for each matrix. Each type of network will have its own algorithm for identifying row names, column names, row types, and column types in a tidy data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">UKEnergy2000_with_metadata &lt;-<span class="st"> </span>UKEnergy2000 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Add a column indicating the matrix in which this entry belongs (U, V, or Y).</span>
<span class="st">  </span>matsindf<span class="op">:::</span><span class="kw"><a href="../reference/add_UKEnergy2000_matnames.html">add_UKEnergy2000_matnames</a></span>(.) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Add columns for row names, column names, row types, and column types.</span>
<span class="st">  </span>matsindf<span class="op">:::</span><span class="kw"><a href="../reference/add_UKEnergy2000_row_col_meta.html">add_UKEnergy2000_row_col_meta</a></span>(.) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="co"># Eliminate columns we no longer need</span>
    <span class="dt">Ledger.side =</span> <span class="ot">NULL</span>,
    <span class="dt">Flow.aggregation.point =</span> <span class="ot">NULL</span>,
    <span class="dt">Flow =</span> <span class="ot">NULL</span>,
    <span class="dt">Product =</span> <span class="ot">NULL</span>, 
    <span class="co"># Ensure that all energy values are positive, as required for analysis.</span>
    <span class="dt">E.ktoe =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(E.ktoe)
  )
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(UKEnergy2000_with_metadata, <span class="dv">2</span>)
<span class="co">#&gt;   Country Year E.ktoe matname           rowname colname  rowtype coltype</span>
<span class="co">#&gt; 1      GB 2000  50000       V Resources - Crude   Crude Industry Product</span>
<span class="co">#&gt; 2      GB 2000  43000       V    Resources - NG      NG Industry Product</span></code></pre></div>
</div>
<div id="collapse" class="section level3">
<h3 class="hasAnchor">
<a href="#collapse" class="anchor"></a>Collapse</h3>
<p>With the metadata now in place, <code>UKEnergy2000_with_metadata</code> can be collapsed to a <code>matsindf</code> data frame by the <code>collapse_to_matrices</code> function. Much like <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarise</a></code>, <code>collapse_to_matrices</code> relies on grouping to indicate which rows of the tidy data frame belong to which matrices. The usual approach is to <code>tidyr::group_by</code> the <code>matnames</code> column and any other columns to be preserved in the output, in this case <code>Country</code> and <code>Year</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">EnergyMats_<span class="dv">2000</span> &lt;-<span class="st"> </span>UKEnergy2000_with_metadata <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Country, Year, matname) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/collapse_to_matrices.html">collapse_to_matrices</a></span>(<span class="dt">matnames =</span> <span class="st">"matname"</span>, <span class="dt">matvals =</span> <span class="st">"E.ktoe"</span>,
                       <span class="dt">rownames =</span> <span class="st">"rowname"</span>, <span class="dt">colnames =</span> <span class="st">"colname"</span>, 
                       <span class="dt">rowtypes =</span> <span class="st">"rowtype"</span>, <span class="dt">coltypes =</span> <span class="st">"coltype"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">matrix.name =</span> matname, <span class="dt">matrix =</span> E.ktoe)

<span class="co"># The remaining columns are Country, Year, matrix.name, and matrix</span>
<span class="kw">glimpse</span>(EnergyMats_<span class="dv">2000</span>)
<span class="co">#&gt; Observations: 3</span>
<span class="co">#&gt; Variables: 4</span>
<span class="co">#&gt; $ Country     &lt;chr&gt; "GB", "GB", "GB"</span>
<span class="co">#&gt; $ Year        &lt;int&gt; 2000, 2000, 2000</span>
<span class="co">#&gt; $ matrix.name &lt;chr&gt; "U", "V", "Y"</span>
<span class="co">#&gt; $ matrix      &lt;list&gt; [&lt;matrix[11 x 9]&gt;, &lt;matrix[11 x 12]&gt;, &lt;matrix[4 x 2…</span>

<span class="co"># To access one of the matrices, try one of these approaches:</span>
(EnergyMats_<span class="dv">2000</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(matrix.name <span class="op">==</span><span class="st"> "U"</span>))[[<span class="st">"matrix"</span>]] <span class="co"># The U matrix</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;                Crude dist. Diesel dist. Elect. grid Gas wells &amp; proc.</span>
<span class="co">#&gt; Crude                    0            0           0                 0</span>
<span class="co">#&gt; Crude - Dist.            0            0           0                 0</span>
<span class="co">#&gt; Crude - Fields       47500            0           0                 0</span>
<span class="co">#&gt; Diesel                   0        15500           0                 0</span>
<span class="co">#&gt; Diesel - Dist.          25            0           0                50</span>
<span class="co">#&gt; Elect                    0            0        6400                 0</span>
<span class="co">#&gt; Elect - Grid            25            0           0                25</span>
<span class="co">#&gt; NG                       0            0           0             43000</span>
<span class="co">#&gt; NG - Dist.               0            0           0                 0</span>
<span class="co">#&gt; NG - Wells               0            0           0                 0</span>
<span class="co">#&gt; Petrol                   0            0           0                 0</span>
<span class="co">#&gt;                NG dist. Oil fields Oil refineries Petrol dist.</span>
<span class="co">#&gt; Crude                 0      50000              0            0</span>
<span class="co">#&gt; Crude - Dist.         0          0          47000            0</span>
<span class="co">#&gt; Crude - Fields        0          0              0            0</span>
<span class="co">#&gt; Diesel                0          0              0            0</span>
<span class="co">#&gt; Diesel - Dist.       25         50              0          250</span>
<span class="co">#&gt; Elect                 0          0              0            0</span>
<span class="co">#&gt; Elect - Grid         25         25             75            0</span>
<span class="co">#&gt; NG                    0          0              0            0</span>
<span class="co">#&gt; NG - Dist.            0          0              0            0</span>
<span class="co">#&gt; NG - Wells        41000          0              0            0</span>
<span class="co">#&gt; Petrol                0          0              0        26500</span>
<span class="co">#&gt;                Power plants</span>
<span class="co">#&gt; Crude                     0</span>
<span class="co">#&gt; Crude - Dist.             0</span>
<span class="co">#&gt; Crude - Fields            0</span>
<span class="co">#&gt; Diesel                    0</span>
<span class="co">#&gt; Diesel - Dist.            0</span>
<span class="co">#&gt; Elect                     0</span>
<span class="co">#&gt; Elect - Grid            100</span>
<span class="co">#&gt; NG                        0</span>
<span class="co">#&gt; NG - Dist.            16000</span>
<span class="co">#&gt; NG - Wells                0</span>
<span class="co">#&gt; Petrol                    0</span>
<span class="co">#&gt; attr(,"rowtype")</span>
<span class="co">#&gt; [1] "Product"</span>
<span class="co">#&gt; attr(,"coltype")</span>
<span class="co">#&gt; [1] "Industry"</span>

EnergyMats_<span class="dv">2000</span><span class="op">$</span>matrix[[<span class="dv">2</span>]] <span class="co"># The V matrix</span>
<span class="co">#&gt;                   Crude Crude - Dist. Crude - Fields Diesel Diesel - Dist.</span>
<span class="co">#&gt; Crude dist.           0         47000              0      0              0</span>
<span class="co">#&gt; Diesel dist.          0             0              0      0          15150</span>
<span class="co">#&gt; Elect. grid           0             0              0      0              0</span>
<span class="co">#&gt; Gas wells &amp; proc.     0             0              0      0              0</span>
<span class="co">#&gt; NG dist.              0             0              0      0              0</span>
<span class="co">#&gt; Oil fields            0             0          47500      0              0</span>
<span class="co">#&gt; Oil refineries        0             0              0  15500              0</span>
<span class="co">#&gt; Petrol dist.          0             0              0      0              0</span>
<span class="co">#&gt; Power plants          0             0              0      0              0</span>
<span class="co">#&gt; Resources - Crude 50000             0              0      0              0</span>
<span class="co">#&gt; Resources - NG        0             0              0      0              0</span>
<span class="co">#&gt;                   Elect Elect - Grid    NG NG - Dist. NG - Wells Petrol</span>
<span class="co">#&gt; Crude dist.           0            0     0          0          0      0</span>
<span class="co">#&gt; Diesel dist.          0            0     0          0          0      0</span>
<span class="co">#&gt; Elect. grid           0         6275     0          0          0      0</span>
<span class="co">#&gt; Gas wells &amp; proc.     0            0     0          0      41000      0</span>
<span class="co">#&gt; NG dist.              0            0     0      41000          0      0</span>
<span class="co">#&gt; Oil fields            0            0     0          0          0      0</span>
<span class="co">#&gt; Oil refineries        0            0     0          0          0  26500</span>
<span class="co">#&gt; Petrol dist.          0            0     0          0          0      0</span>
<span class="co">#&gt; Power plants       6400            0     0          0          0      0</span>
<span class="co">#&gt; Resources - Crude     0            0     0          0          0      0</span>
<span class="co">#&gt; Resources - NG        0            0 43000          0          0      0</span>
<span class="co">#&gt;                   Petrol - Dist.</span>
<span class="co">#&gt; Crude dist.                    0</span>
<span class="co">#&gt; Diesel dist.                   0</span>
<span class="co">#&gt; Elect. grid                    0</span>
<span class="co">#&gt; Gas wells &amp; proc.              0</span>
<span class="co">#&gt; NG dist.                       0</span>
<span class="co">#&gt; Oil fields                     0</span>
<span class="co">#&gt; Oil refineries                 0</span>
<span class="co">#&gt; Petrol dist.               26000</span>
<span class="co">#&gt; Power plants                   0</span>
<span class="co">#&gt; Resources - Crude              0</span>
<span class="co">#&gt; Resources - NG                 0</span>
<span class="co">#&gt; attr(,"rowtype")</span>
<span class="co">#&gt; [1] "Industry"</span>
<span class="co">#&gt; attr(,"coltype")</span>
<span class="co">#&gt; [1] "Product"</span>

EnergyMats_<span class="dv">2000</span><span class="op">$</span>matrix[[<span class="dv">3</span>]] <span class="co"># The Y matrix</span>
<span class="co">#&gt;                Residential Transport</span>
<span class="co">#&gt; Diesel - Dist.           0     14750</span>
<span class="co">#&gt; Elect - Grid          6000         0</span>
<span class="co">#&gt; NG - Dist.           25000         0</span>
<span class="co">#&gt; Petrol - Dist.           0     26000</span>
<span class="co">#&gt; attr(,"rowtype")</span>
<span class="co">#&gt; [1] "Product"</span>
<span class="co">#&gt; attr(,"coltype")</span>
<span class="co">#&gt; [1] "Sector"</span></code></pre></div>
</div>
<div id="duplicate-for-purposes-of-illustration" class="section level3">
<h3 class="hasAnchor">
<a href="#duplicate-for-purposes-of-illustration" class="anchor"></a>Duplicate (for purposes of illustration)</h3>
<p>Larger studies will include data for multiple countries and years. The ECC data from UK in year <code>2000</code> can be duplicated for <code>2001</code> and for a fictitious country <code>AB</code>. Although the data are unchanged, the additional rows serve to illustrate the functional programming aspects of the <code>matsindf</code> and <code>matsbyname</code> packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Energy &lt;-<span class="st"> </span>EnergyMats_<span class="dv">2000</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Create rows for a fictitious country "AB".</span>
<span class="st">  </span><span class="co"># Although the rows for "AB" are same as the "GB" rows,</span>
<span class="st">  </span><span class="co"># they serve to illustrate functional programming with matsindf.</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(EnergyMats_<span class="dv">2000</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Country =</span> <span class="st">"AB"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> Year, <span class="dt">value =</span> matrix) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="co"># Create a column for a second year (2001).</span>
    <span class="st">`</span><span class="dt">2001</span><span class="st">`</span> =<span class="st"> `</span><span class="dt">2000</span><span class="st">`</span>
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> Year, <span class="dt">value =</span> matrix, <span class="st">`</span><span class="dt">2000</span><span class="st">`</span>, <span class="st">`</span><span class="dt">2001</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Now spread to put each matrix in a column.</span>
<span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> matrix.name, <span class="dt">value =</span> matrix)

<span class="kw">glimpse</span>(Energy)
<span class="co">#&gt; Observations: 4</span>
<span class="co">#&gt; Variables: 5</span>
<span class="co">#&gt; $ Country &lt;chr&gt; "AB", "AB", "GB", "GB"</span>
<span class="co">#&gt; $ Year    &lt;chr&gt; "2000", "2001", "2000", "2001"</span>
<span class="co">#&gt; $ U       &lt;list&gt; [&lt;matrix[11 x 9]&gt;, &lt;matrix[11 x 9]&gt;, &lt;matrix[11 x 9]&gt;, …</span>
<span class="co">#&gt; $ V       &lt;list&gt; [&lt;matrix[11 x 12]&gt;, &lt;matrix[11 x 12]&gt;, &lt;matrix[11 x 12]…</span>
<span class="co">#&gt; $ Y       &lt;list&gt; [&lt;matrix[4 x 2]&gt;, &lt;matrix[4 x 2]&gt;, &lt;matrix[4 x 2]&gt;, &lt;ma…</span></code></pre></div>
</div>
<div id="verify-data" class="section level3">
<h3 class="hasAnchor">
<a href="#verify-data" class="anchor"></a>Verify data</h3>
<p>An important step in any analysis is data verification. For an ECC analysis, it is important to verify that energy is conserved (i.e., energy is in balance) across all industries. Equations 1 and 2 in Heun, Owen, and Brockway <span class="citation">(2018)</span> show that energy balance is verified by</p>
<p><span class="math display">\[{\mathbf{W}} = {{\mathbf{V}}^\mathrm{T}} - {\mathbf{U}},\]</span></p>
<p>and</p>
<p><span class="math display">\[{\mathbf{W}}{\mathbf{i}} - {\mathbf{Y}}{\mathbf{i}} = {\mathbf{0}}.\]</span></p>
<p>Energy balance verification can be implemented with <code>matsbyname</code> functions and <code>tidyverse</code> functional programming:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Check &lt;-<span class="st"> </span>Energy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">W =</span> <span class="kw">difference_byname</span>(<span class="kw">transpose_byname</span>(V), U),
    <span class="co"># Need to change column name and type on y so it can be subtracted from row sums of W</span>
    <span class="dt">err =</span> <span class="kw">difference_byname</span>(<span class="kw">rowsums_byname</span>(W), 
                            <span class="kw">rowsums_byname</span>(Y) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                              </span><span class="kw">setcolnames_byname</span>(<span class="st">"Industry"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setcoltype</span>(<span class="st">"Industry"</span>)),
    <span class="dt">EBalOK =</span> <span class="kw">iszero_byname</span>(err)
  )
Check <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Country, Year, EBalOK)
<span class="co">#&gt;   Country Year EBalOK</span>
<span class="co">#&gt; 1      AB 2000   TRUE</span>
<span class="co">#&gt; 2      AB 2001   TRUE</span>
<span class="co">#&gt; 3      GB 2000   TRUE</span>
<span class="co">#&gt; 4      GB 2001   TRUE</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(Check<span class="op">$</span>EBalOK <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>())
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>This example demonstrates that energy balance can be verified for <em>all</em> combinations of Country and Year with a few lines of code. In fact, the exact same code can be applied to the <code>Energy</code> data frame, regardless of the number of rows in it.</p>
<p>Secure in the knowledge that energy is conserved across all ECCs in the <code>Energy</code> data frame, other analyses can proceed.</p>
</div>
<div id="efficiencies" class="section level3">
<h3 class="hasAnchor">
<a href="#efficiencies" class="anchor"></a>Efficiencies</h3>
<p>To further illustrate the power of <code>matsbyname</code> functions in the context of <code>matsindf</code>, consider the calculation of the efficiency of every industry in the ECC as column vector <span class="math inline">\(\eta\)</span> as shown by Equation 11 of Heun, Owen, and Brockway <span class="citation">(2018)</span>.</p>
<p><span class="math display">\[{\mathbf{g}} = {\mathbf{V}}{\mathbf{i}}\]</span></p>
<p><span class="math display">\[{\mathbf{\eta}} = {{\widehat{{{\mathbf{U}}^\mathrm{T}} {\mathbf{i}}}^{\mathrm{-}1}}} {\mathbf{g}}\]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Etas &lt;-<span class="st"> </span>Energy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">g =</span> <span class="kw">rowsums_byname</span>(V),
    <span class="dt">eta =</span> <span class="kw">transpose_byname</span>(U) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rowsums_byname</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">hatize_byname</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">invert_byname</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">matrixproduct_byname</span>(g) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">setcolnames_byname</span>(<span class="st">"eta"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setcoltype</span>(<span class="st">"Efficiency"</span>)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Country, Year, eta)

Etas<span class="op">$</span>eta[[<span class="dv">1</span>]]
<span class="co">#&gt;                         eta</span>
<span class="co">#&gt; Crude dist.       0.9884332</span>
<span class="co">#&gt; Diesel dist.      0.9774194</span>
<span class="co">#&gt; Elect. grid       0.9804688</span>
<span class="co">#&gt; Gas wells &amp; proc. 0.9518282</span>
<span class="co">#&gt; NG dist.          0.9987820</span>
<span class="co">#&gt; Oil fields        0.9485771</span>
<span class="co">#&gt; Oil refineries    0.8921933</span>
<span class="co">#&gt; Petrol dist.      0.9719626</span>
<span class="co">#&gt; Power plants      0.3975155</span>
<span class="co">#&gt; attr(,"rowtype")</span>
<span class="co">#&gt; [1] "Industry"</span>
<span class="co">#&gt; attr(,"coltype")</span>
<span class="co">#&gt; [1] "Efficiency"</span></code></pre></div>
<p>Note that only a few lines of code are required to perform the same series of matrix operations on every combination of <code>Country</code> and <code>Year</code>. In fact, the same code will be used to calculate the efficiency of any number of industries in any number of countries and years!</p>
</div>
<div id="expand" class="section level3">
<h3 class="hasAnchor">
<a href="#expand" class="anchor"></a>Expand</h3>
<p>Plotting values from a <code>matsindf</code> data frame can be accomplished by <em>expand</em>ing the matrices of the <code>matsindf</code> data frame (in this example, <code>Etas</code>) back out to a tidy data frame. <em>Expand</em>ing is the reverse of <em>collapse</em>-ing, and the following information must be supplied to the <code>expand_to_tidy</code> function:</p>
<table class="table">
<thead><tr class="header">
<th align="right">argument to <code>expand_to_tidy</code>
</th>
<th align="left">identifies</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right"><code>matnames</code></td>
<td align="left">Name of the input column of matrix names</td>
</tr>
<tr class="even">
<td align="right"><code>matvals</code></td>
<td align="left">Name of the input column of matrices to be expanded</td>
</tr>
<tr class="odd">
<td align="right"><code>rownames</code></td>
<td align="left">Name of the output column of matrix row names</td>
</tr>
<tr class="even">
<td align="right"><code>colnames</code></td>
<td align="left">Name of the output column of matrix column name</td>
</tr>
<tr class="odd">
<td align="right"><code>rowtypes</code></td>
<td align="left">Optional name of the output column of matrix row types</td>
</tr>
<tr class="even">
<td align="right"><code>coltypes</code></td>
<td align="left">Optional name of the output column of matrix column types</td>
</tr>
<tr class="odd">
<td align="right"><code>drop</code></td>
<td align="left">Optional value to be dropped from output (often 0)</td>
</tr>
</tbody>
</table>
<p>Prior to <code>expand</code>ing, it is usually necessary to <code>gather</code> columns of matrices.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">etas_forgraphing &lt;-<span class="st"> </span>Etas <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> matrix.names, <span class="dt">value =</span> matrix, eta) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/expand_to_tidy.html">expand_to_tidy</a></span>(<span class="dt">matnames =</span> <span class="st">"matrix.names"</span>, <span class="dt">matvals =</span> <span class="st">"matrix"</span>, 
                 <span class="dt">rownames =</span> <span class="st">"Industry"</span>, <span class="dt">colnames =</span> <span class="st">"etas"</span>, 
                 <span class="dt">rowtypes =</span> <span class="st">"rowtype"</span>, <span class="dt">coltypes =</span> <span class="st">"Efficiencies"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="co"># Eliminate columns we no longer need.</span>
    <span class="dt">matrix.names =</span> <span class="ot">NULL</span>,
    <span class="dt">etas =</span> <span class="ot">NULL</span>, 
    <span class="dt">rowtype =</span> <span class="ot">NULL</span>, 
    <span class="dt">Efficiencies =</span> <span class="ot">NULL</span>
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(
    <span class="dt">eta =</span> matrix
  )

<span class="co"># Compare to Figure 8 of Heun, Owen, and Brockway (2018)</span>
etas_forgraphing <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(Country <span class="op">==</span><span class="st"> "GB"</span>, Year <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>)
<span class="co">#&gt; # A tibble: 9 x 4</span>
<span class="co">#&gt;   Country Year  Industry            eta</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;             &lt;dbl&gt;</span>
<span class="co">#&gt; 1 GB      2000  Crude dist.       0.988</span>
<span class="co">#&gt; 2 GB      2000  Diesel dist.      0.977</span>
<span class="co">#&gt; 3 GB      2000  Elect. grid       0.980</span>
<span class="co">#&gt; 4 GB      2000  Gas wells &amp; proc. 0.952</span>
<span class="co">#&gt; 5 GB      2000  NG dist.          0.999</span>
<span class="co">#&gt; 6 GB      2000  Oil fields        0.949</span>
<span class="co">#&gt; 7 GB      2000  Oil refineries    0.892</span>
<span class="co">#&gt; 8 GB      2000  Petrol dist.      0.972</span>
<span class="co">#&gt; 9 GB      2000  Power plants      0.398</span></code></pre></div>
<p><code>etas_forgraphing</code> is a data frame of efficiencies, one for each Country, Year, and Industry, in a format that is amenable to plotting with packages such as <a href="http://ggplot2.tidyverse.org">ggplot</a>.</p>
</div>
<div id="report" class="section level3">
<h3 class="hasAnchor">
<a href="#report" class="anchor"></a>Report</h3>
<p>The following code creates a bar graph of efficiency results for the UK in 2000:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">etas_UK_<span class="dv">2000</span> &lt;-<span class="st"> </span>etas_forgraphing <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(Country <span class="op">==</span><span class="st"> "GB"</span>, Year <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>) 

etas_UK_<span class="dv">2000</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">"Industry"</span>, <span class="dt">y =</span> <span class="st">"eta"</span>, 
                              <span class="dt">fill =</span> <span class="st">"Industry"</span>, <span class="dt">colour =</span> <span class="st">"Industry"</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(eta[UK<span class="op">*</span><span class="st">","</span><span class="op">*</span><span class="dv">2000</span>]), <span class="dt">fill =</span> <span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.2</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="st">"white"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(etas_UK_<span class="dv">2000</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="st">"gray20"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(etas_UK_<span class="dv">2000</span>))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>, <span class="dt">colour =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">vjust =</span> <span class="fl">0.4</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="matsindf_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>This vignette demonstrated the use of the <code>matsindf</code> and <code>matsbyname</code> packages and suggested a workflow to accomplish sophisticated analyses using <em>matrices in data frames</em> (<code>matsindf</code>).</p>
<p>The workflow is as follows:</p>
<ul>
<li>Reshape data into a tidy data frame with columns for matrix name, element value, row name, column name, row type, and column type, similar to <code>UKEnergy2000</code> above.</li>
<li>Use <code>collapse_to_matrices</code> to create a data frame of matrices with columns for matrix names and matrices themselves, similar to <code>EnergyMats_2000</code> above.</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/spread.html">tidyr::spread</a></code> the matrices to obtain a data frame with columns for each matrix, similar to <code>Energy</code> above.</li>
<li>Validate the data, similar to <code>Check</code> above.</li>
<li>Perform matrix algebra operations on the columns of matrices using <code>matsbyname</code> functions in a manner similar to the process of generating the <code>Etas</code> data frame above.</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/gather.html">tidyr::gather</a></code> the columns to obtain a tidy data frame of matrices.</li>
<li>Use <code>expand_to_tidy</code> to create a tidy data frame of matrix elements, similar to <code>etas_forgraphing</code> above.</li>
<li>Plot and report results as demonstrated by the graph above.</li>
</ul>
<p>Data frames of matrices, such as those created by <code>matsindf</code>, are like magic spreadsheets in which single cells contain entire matrices. With this data structure, analysts can wield simultaneously the power of both <a href="https://en.wikipedia.org/wiki/Matrix_(mathematics)">matrix mathematics</a> and <a href="http://www.tidyverse.org">tidyverse</a> functional programming.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Heun:2018">
<p>Heun, Matthew Kuperus, Anne Owen, and Paul E. Brockway. 2018. “A Physical Supply-Use Table Framework for Energy Analysis on the Energy Conversion Chain.” <em>Applied Energy</em> 226 (September): 1134–62. doi:<a href="https://doi.org/10.1016/j.apenergy.2018.05.109">10.1016/j.apenergy.2018.05.109</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-ukenergy2000">Data: <code>UKEnergy2000</code></a></li>
      <li><a href="#suggested-workflow">Suggested workflow</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matthew Heun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
